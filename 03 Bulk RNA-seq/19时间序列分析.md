### 19时间序列分析



```R
rm(list = ls())
options(stringsAsFactors = F)
BiocManager::install("org.At.tair.db", lib = "/home/data/t150618/R/x86_64-pc-linux-gnu-library/4.4")
#安装V0.1.2,适合R4.4
BiocManager::install("junjunlab/ClusterGVis@V0.1.2")
#如果安装失败可以使用本地安装
#安装并加载 devtools：
if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools")
}
library(devtools)

# 将 "workdir_bak/junjunlab-ClusterGVis-V0.1.2-0-ge143512.tar.gz" 替换为你的实际路径
install_local(
  path = "workdir_bak/junjunlab-ClusterGVis-V0.1.2-0-ge143512.tar.gz",
  dependencies = TRUE,
  repos = c(CRAN = "https://cloud.r-project.org/"),
  bioc = TRUE
)




library(org.At.tair.db)
library(ClusterGVis)


#输入数据是标准化的 tpm/fpkm/rpkm 表达矩阵,有两种方法进行聚类,分别是 Mfuzz 的fuzzy c-means 聚类算法和 ComplexHeatmap 的 row_km 的 Kmeans 聚类算法,用户可根据自己喜好选择。

#导入数据为tpm平均值矩阵
#save(gene_exp,gene_exp_avg,file = "4SampleHheatmapPCA/gene_exp_avg.Rdata")
load(file = "4SampleHheatmapPCA/gene_exp_avg.Rdata")
exps = gene_exp_avg

# 查看数据
head(exps,3)

#选择高变基因用于后续分析
## 方法1：基于MAD选择前5000个变异最大的基因
exps = exps[ # 对表达矩阵exps进行行筛选
  order(     # order函数返回排序后的索引（从小到大）
    apply(exps, 1, mad), # 对矩阵exp的每一行(1表示按行)计算MAD(中位数绝对偏差)
    decreasing = T      # 将order的默认顺序(升序)改为降序，即MAD值最大的行排在前面
  )[1:5000], # 取排序后前5000个索引，即MAD最大的5000行
]
## 方法2：基于方差选择前25%变异最大的基因
exps = exps[ # 再次对表达矩阵exps进行行筛选（这会覆盖上一次筛选结果）
  order(     # order函数返回排序后的索引
    apply(exps, 1, var), # 对矩阵exp的每一行计算方差(variance)
    decreasing = T      # 降序排列，方差最大的行排在前面
  )[1:round(0.25*nrow(exps))], # 取前25%的行(四舍五入到整数)
]


#具体聚类的多少可以结合热图结果进行选择最佳的数量。
getClusters(exp=exps)
ggsave(
    filename = "10Time_Series/Clusters_num.pdf",
    device = "pdf",
    width = 10,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)



# 聚类,选择 8 个聚类数量:有两种方法进行聚类,分别是 Mfuzz 的fuzzy c-means 聚类算法和 ComplexHeatmap 的 row_km 的 Kmeans 聚类算法

cm<-clusterData(exp=exps,
                  cluster.method="mfuzz", #"kmeans"or "mfuzz"
                  cluster.num=8)


#绘制折线图:
visCluster(object=cm,
           plot.type="line")
ggsave(
    filename = "10Time_Series/line1.pdf",
    device = "pdf",
    width = 16,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)

visCluster(object=cm,
           plot.type="line",
           ms.col=c("green","orange","red"))
ggsave(
    filename = "10Time_Series/line2.pdf",
    device = "pdf",
    width = 16,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)
visCluster(object=cm,
           plot.type="line",
           ms.col=c("green","orange","red"),
           add.mline=FALSE)
ggsave(
    filename = "10Time_Series/line3.pdf",
    device = "pdf",
    width = 16,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)







#绘制富集分析图



#筛选需要标记的基因（根据课题筛选）
markGenes = row.names(exps[ # 再次对表达矩阵exps进行行筛选（这会覆盖上一次筛选结果）
    order(     # order函数返回排序后的索引
        apply(exps, 1, var), # 对矩阵exp的每一行计算方差(variance)
        decreasing = T      # 降序排列，方差最大的行排在前面
    )[1:30], ])


#画个热图
pdf('10Time_Series/pheatmap.pdf',height=16,width=10,onefile=F)
visCluster(object=cm,
           plot.type="both",
           line.side="left",
           column_names_rot=45,
           markGenes=markGenes,
           show_row_dend=F,
           cluster.order=c(1:8))
dev.off()


#富集分析
keytypes(org.At.tair.db)

enrich<-enrichCluster(object=cm,
                        OrgDb=org.At.tair.db,
                        type="BP",
                        fromType = "TAIR", # 明确指定基因ID类型,输入ID类型，默认为“SYMBOL”。
                        organism="ath",#“KEGG”富集的生物名称，小鼠（“mmu”），人类（“hsa”），拟南芥"ath",默认NULL。
                        pvalueCutoff=0.5,
                        topn=5,
                        seed=5201314)

# check
head(enrich,3)


#绘制条形图:
# barplot
palette=c("Grays","Light Grays","Blues2","Blues3","Purples2","Purples3","Reds2","Reds3","Greens2")
# loop
lapply(seq_along(unique(enrich$group)),function(x){
  tmp<-enrich|>dplyr::filter(group==unique(enrich$group)[x])|>
    dplyr::arrange(desc(pvalue))

  tmp$Description<-factor(tmp$Description,levels=tmp$Description)

  # plot
  p<-
   ggplot(tmp)+
      geom_col(aes(x=-log10(pvalue),y=Description,fill=-log10(pvalue)),
               width=0.75)+
      geom_line(aes(x=log10(ratio),y=as.numeric(Description)),color="grey50")+
      geom_point(aes(x=log10(ratio),y=Description),size=3,color="orange")+
      theme_bw()+
      scale_y_discrete(position="right",
                       labels=function(x) stringr::str_wrap(x, width=40))+
      scale_x_continuous(sec.axis=sec_axis(~.,name="log10(ratio)"))+
      colorspace::scale_fill_binned_sequential(palette=palette[x])+
      ylab("")

  return(p)
})->gglist

# assign names
names(gglist)<-paste("C",1:8,sep="")#几个分组写几
    
#绘制组合图（热图加富集分析）
    
pdf('10Time_Series/pheatmap_go.pdf',height=20,width=16,onefile=F)
visCluster(object=cm,
           plot.type="both",
           line.side="left",
           column_names_rot=45,
           markGenes=markGenes,
           show_row_dend=F,
           cluster.order=c(1:8),
           ggplot.panel.arg=c(5,0.5,16,"grey90",NA),
           gglist=gglist)
dev.off()
    
```

