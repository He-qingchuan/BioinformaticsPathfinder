## 火山图

```r
setwd("workdir")
BiocManager::install("EnhancedVolcano")
if(!require(ggrepel))install.packages('ggrepel')

library(ggrepel)
library(EnhancedVolcano)



#提取数据
de_result <- read_delim("5DESeq2/de_result.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)

# 去除无用的列
select(de_result, gene_id, sampleA, sampleB, log2FoldChange, padj) %>%
  # 添加 direction 列
  mutate(direction = if_else(abs(log2FoldChange) < 1 | padj > 0.05, 'ns', 
                             if_else(log2FoldChange >= 1, 'up', 'down'))) -> de_result
###保存
write_csv(de_result, "7volcano/de_result_6col.csv")


my_de_result <- filter(de_result, 
                       sampleA == "ZT20",
                       sampleB == "ZT0") %>%
  arrange(desc(abs(log2FoldChange)))

save(de_result,file = "7volcano/de_result.Rdata")
save(de_result,file = "7volcano/my_de_result.Rdata")

#load(file = "7volcano/my_de_result.Rdata")



#火山图使用1EnhancedVolcano绘制
plot <- EnhancedVolcano(my_de_result,
    lab = my_de_result$gene_id,
    selectLab = c(''),## 标记目标基因(无)
    x = 'log2FoldChange',
    y = 'padj',
    title = 'ZT20 VS ZT0',
    pCutoff = 0.01,
    FCcutoff = 2,
    pointSize = 1.5,
    col=c('black', 'black', 'black', 'red3'),
    colAlpha = 1,
    labSize = 3.0)

ggsave(
    filename = "7volcano/Volcano1A.pdf",
    plot = plot ,
    device = "pdf",
    width = 10,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)






# 过滤上下调top10的基因：
top_m <- my_de_result %>% group_by(direction) %>% top_n(n = -10, wt = padj) %>%  # 如果你想改成top10，把5替换成对应的数字就好，top_n(n = -10, wt = padj)最小的10个
filter(direction !='ns') 
plot <- EnhancedVolcano(my_de_result,
    lab = my_de_result$gene_id,
    selectLab = c(top_m$gene_id),## 标记目标基因(无)
    x = 'log2FoldChange',
    y = 'padj',
    title = 'ZT20 VS ZT0',
    pCutoff = 0.01,
    FCcutoff = 2,
    pointSize = 1.5,
    col=c('black', 'black', 'black', 'red3'),
    colAlpha = 4/5,
    labSize = 3.0,
    #标签加框
    boxedLabels = TRUE,
    drawConnectors = TRUE,
    legendPosition = 'right',
    legendLabSize = 14,
    legendIconSize = 4.0)





ggsave(
    filename = "7volcano/Volcano1B.pdf",
    plot = plot ,
    device = "pdf",
    width = 10,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)








#火山图2使用ggplot2
######## 火山图 ##########
data <- data.frame(gene = my_de_result$gene_id,
                   pval = -log10(my_de_result$padj), #pval已做-log10处理
                   lfc = my_de_result$log2FoldChange)
#将 pval 列中的 Inf 值替换为该列最大值加 1 
data$pval[is.infinite(data$pval)] <- max(data$pval[is.finite(data$pval)], na.rm = TRUE) + 1
data
# 查看数据：
head(data)

# pval 小于0.05，且上下调log(Foldchange)大于1(差异倍数为2)的为显著差异基因并标注上下调，其余
data <- mutate(data, type = case_when(data$lfc >  1 & data$pval > abs(log10(0.05)) ~ "Up",
                                      data$lfc < -1 & data$pval > abs(log10(0.05)) ~ "Down",
                                      data$pval < abs(log10(0.05)) ~ "no.Sig"))
# 去除包含na的数据
data <- na.omit(data)

plot <- ggplot(data,aes(lfc, pval))+# 横坐标为差异倍数，纵坐标为显著性
  # 横向水平参考线：
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "#999999")+
  # 纵向垂直参考线：
  geom_vline(xintercept = c(-0.5,0.5), linetype = "dashed", color = "#999999")+
  # 散点图:
  geom_point(aes(size=pval, shape=type,color= pval))+
  # 指定颜色渐变模式：
  scale_shape_manual(values = c(6,1,2))+
  scale_color_gradientn(values = seq(0,1,0.2),
                        colors = c("#39489f","#39bbec",'#FFA500',"#f38466","#b81f25"))+
  # 指定散点大小渐变模式：
  scale_size_continuous(range = c(0.5,4))+
  # 主题调整：
  theme_bw()+
  guides(col = guide_colourbar(title = "-Log10_q-value"),
         size = "none")+
  xlab("Log2FC")+
  ylab("-Log10(FDR q-value)")+
  scale_y_continuous(trans = "log1p")

# 这时的火山图还是光秃秃的：
print(plot)

ggsave(
    filename = "7volcano/Volcano2A.pdf",
    plot = plot,
    device = "pdf",
    width = 10,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)









# 过滤上下调top5的基因：
top_m <- data %>% group_by(type) %>% top_n(n = 30, wt = pval) %>%  # 如果你想改成top10，把5替换成对应的数字就好
  filter(type !='no.Sig')           
# 把top标签添加到火山图中
plot <- plot +
  geom_text_repel(data=top_m,aes(x=lfc,y=pval,label=gene), size = 3)


# 查看最终的火山图，这时标签已经被添加好啦：
print(plot)

ggsave(
    filename = "7volcano/Volcano2B.pdf",
    plot = plot,
    device = "pdf",
    width = 10,      # 宽度（英寸）
    height = 8,      # 高度（英寸）
    dpi = 300
)

```