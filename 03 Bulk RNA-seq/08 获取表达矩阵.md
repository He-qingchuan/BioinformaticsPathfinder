

## 08 获取表达矩阵

###转录本定量转为基因定量及标准化

```{bash}
#tx2gene
#tx2gene自己制作'gene(tab)transcript' identifiers per line，但不要有表头，只有基因和转录本id就行

#NR>1：从第二行开始处理（跳过第一行的标题）
#{print $1}：打印每行的第一列
#-F '.'：使用点作为字段分隔符
#{print $1 "\t" $0}：打印第一个字段（点之前的部分）加上制表符，再打印完整的转录本名

awk 'NR>1 {print $1}' tpm.txt | awk -F '.' '{print $1 "\t" $0}'  > tx2gene.txt 


#quant_files.txt制作
##对quant_files.txt排序，要和samples.txt顺序一样,deseq2的要求，可以提前调整好因子顺序，从后往前排，默认是从前往后依次两两比对
find $workdir/3Salmon/ -type f -name "*.sf" | sort >quant_files.txt


# 调用 Perl 脚本 abundance_estimates_to_matrix.pl
# 设置表达量估计方法为 Salmon
# 提供基因到转录本的映射文件 tx2gene.txt
# 设置输出结果的文件前缀为 "quanti/genes"
# 使用输入文件所在目录名称来命名样本，避免列名冲突
# 提供包含所有样本对应的 quant.sf 文件路径的文本文件 quant_files.txt
# 将标准输出（stdout）重定向到日志文件 logs/abundance_estimates_to_matrix.log
# 将标准错误输出（stderr）重定向到标准输出，使得所有日志信息（包括错误信息）都保存在同一个日志文件中

#mkdir -p quanti创建输出目录
mkdir -p quanti
abundance_estimates_to_matrix.pl \
  --est_method salmon \
  --gene_trans_map tx2gene.txt \
  --out_prefix quanti/genes \
  --name_sample_by_basedir \
  --quant_files quant_files.txt \
  1>abundance_estimates_to_matrix.log \
  2>&1

# genes.gene.counts.matrix
#     - 基因级别的原始计数矩阵文件。
#     - 行代表每个基因，列代表每个样本，每个单元格表示该基因在相应样本中的测序计数。
#     - 原始计数通常用于差异表达分析（如 DESeq2 或 edgeR），因为这些分析方法使用原始计数来建模。
# 
# genes.gene.TMM.EXPR.matrix
#     - 基因级别的表达量矩阵，经过 TMM（Trimmed Mean of M-values）标准化。
#     - 行表示基因，列表示样本，每个单元格表示 TMM 标准化后的表达量。
#     - TMM 标准化用于消除不同样本间的测序深度差异，使得表达量数据可以在样本间进行直接比较。
# 
# genes.gene.TPM.not_cross_norm
#     - 基因级别的 TPM（Transcripts Per Million）表达量矩阵，未经过 TMM 标准化。
#     - 行表示基因，列表示样本，每个单元格为该基因在对应样本中的 TPM 值。
#     - TPM 是一种标准化单位，用于比较单个样本中不同基因的表达量，但不适合直接在样本间进行比较。
# 
# genes.gene.TPM.not_cross_norm.runTMM.R
#     - R 脚本，用于将未标准化的 TPM 表达量矩阵应用 TMM 标准化。
#     - 该脚本使用原始的 TPM 数据，并执行 TMM 标准化，使得结果矩阵可以在样本间比较。
# 
# genes.gene.TPM.not_cross_norm.TMM_info.txt
#     - 包含 TMM 标准化过程中的信息文件。
#     - 记录了 TMM 标准化的相关参数（如标准化系数和样本大小因子），用于后续结果复核或质量控制。
# 
# genes.isoform.counts.matrix
#     - 转录本级别的原始计数矩阵文件。
#     - 行表示每个转录本，列表示每个样本，每个单元格为该转录本在相应样本中的测序计数。
#     - 通常用于差异表达分析，尤其是在分析不同转录本的表达变化时使用。
# 
# genes.isoform.TMM.EXPR.matrix
#     - 转录本级别的表达量矩阵，tpm经过 TMM 标准化（已查正过）。
#     - 行表示转录本，列表示样本，每个单元格为 TMM 标准化后的表达量。
#     - 使得转录本间的表达量可以在不同样本中直接比较，消除了样本间的测序深度差异。
# 
# genes.isoform.TPM.not_cross_norm
#     - 转录本级别的 TPM 表达量矩阵，未经过 TMM 标准化。
#     - 行表示转录本，列表示样本，每个单元格为该转录本在相应样本中的 TPM 值。
#     - TPM 用于单个样本内转录本间表达量的相对比较，但未标准化的 TPM 值不适合直接用于样本间的比较。
# 
# genes.isoform.TPM.not_cross_norm.runTMM.R
#     - R 脚本，用于将未标准化的转录本 TPM 表达量矩阵应用 TMM 标准化。
#     - 该脚本会处理未标准化的 TPM 表达量矩阵，生成可以在样本间进行直接比较的标准化数据。
# 
# genes.isoform.TPM.not_cross_norm.TMM_info.txt
#     - 包含转录本级别 TMM 标准化过程的相关信息文件。
#     - 记录了 TMM 标准化中的相关参数，用于质量控制或复核标准化过程的准确性。
#Trimmed Mean of M-values (TMM) 是一种标准化方法，用于校正 RNA-Seq 数据中不同样本间测序深度和文库复杂度的差异，以便于直接比较各样本的基因表达量。TMM 方法通过计算每个基因在样本间的表达比值（即 M 值），并对这些比值进行剪裁（去除极端值），以获得每个样本的标准化因子，从而对表达量进行调整。参考文献：http://bib.oxfordjournals.org/content/14/6/671.long，http://www.genomebiology.com/2010/11/3/R25


  #添加基因列列名
    sed -i '1s/^/gene_id/' quanti/genes.gene.counts.matrix
    sed -i '1s/^/gene_id/' quanti/genes.gene.TMM.EXPR.matrix
    sed -i '1s/^/gene_id/' quanti/genes.gene.TPM.not_cross_norm
    
    
    #更改列名符合样本名
    sed -i '1s/.quant//g' quanti/genes.gene.counts.matrix
    sed -i '1s/.quant//g' quanti/genes.gene.TMM.EXPR.matrix
    sed -i '1s/.quant//g' quanti/genes.gene.TPM.not_cross_norm
    
  



cd ../4SampleHheatmapPCA
#拷贝基因表达矩阵数据到当前目录
ln -s  ../3Salmon/quanti/ ./

#获取samples.txt，即样本文件（内容包括两列，没有列名，第一列样本的分组，第二列是样本名，以ZT0_rep_1为例，写为：ZT0	ZT0_rep_1）
head -n 1 ../3Salmon/quanti/genes.gene.counts.matrix | awk '
{
    # 跳过第一列 "gene_id"
    for (i=2; i<=NF; i++) {
        # 提取分组（第一个_前的内容）
        split($i, parts, "_")
        group = parts[1]
        # 打印分组和样本名，用制表符分隔
        print group "\t" $i
    }
}' > samples.txt

```

